<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bus Pickup System Demo</title>
  <style>
    body{font-family:Arial, sans-serif;direction:ltr;padding:20px;background:#f6f6f9;color:#222}
    h1{font-size:22px;margin-bottom:10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    label{display:block;margin-top:8px}
    input,select,button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ccc}
    button{cursor:pointer;background:#333;color:#fff;font-weight:600}
    button:hover{background:#555}
    .bus-list{margin-top:12px}
    .bus{padding:8px;border-radius:6px;border:1px solid #eee;margin-bottom:8px}
    .success{color:green}
    .warn{color:#b35a00}
    .small{font-size:13px;color:#666}
    .row{display:flex;gap:8px;margin-top:10px}
    .col{flex:1}
    .scan-area{height:300px;background:#111;border-radius:8px;color:#fff;display:flex;align-items:center;justify-content:center;margin-top:10px}
  </style>
</head>
<body>
  <h1>Bus Pickup System (HTML/CSS/JavaScript Example)</h1>

  <div class="grid">
    <!-- Bus Section -->
    <div>
      <div class="card">
        <h2>Bus Management (Admin)</h2>
        <p class="small">Add or edit buses with their capacity. The system automatically assigns students to the least loaded bus.</p>
        <label>Bus Name</label>
        <input id="busName" placeholder="e.g. Bus 1" />
        <label>Maximum Capacity</label>
        <input id="busCap" type="number" value="10" />
        <button id="addBus">Add / Update Bus</button>
        <div class="bus-list" id="buses"></div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Admin Dashboard</h2>
        <p class="small">View buses, current passengers, and student status.</p>
        <div id="dashboard"></div>
      </div>
    </div>

    <!-- Student Section -->
    <div>
      <div class="card">
        <h2>Student Registration</h2>
        <p class="small">Students fill this form to register and will be automatically assigned to a bus.</p>
        <label>Student Name</label>
        <input id="studentName" placeholder="Enter full name" />
        <label>Pickup Location</label>
        <input id="pickupPoint" placeholder="Street / Building / Area" />
        <button id="registerStudent">Register & Assign Bus</button>
        <div id="registerResult" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Student QR Code</h2>
        <p class="small">After registration, a QR code will be generated. Scan it when finishing the day.</p>
        <div id="studentCodeArea" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>QR Scan (Daily Checkout)</h2>
        <p class="small">Use a camera to scan the QR code when the student leaves the university.</p>
        <div id="scanner" class="scan-area">Scanner will appear here when started</div>
        <div class="row">
          <button id="startScan">Start Scanning</button>
          <button id="stopScan">Stop Scanning</button>
        </div>
        <div id="scanLog" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script>
    const buses = [];
    const students = {};

    const busesDiv = document.getElementById('buses');
    const dashboard = document.getElementById('dashboard');
    const registerResult = document.getElementById('registerResult');
    const studentCodeArea = document.getElementById('studentCodeArea');
    const scanLog = document.getElementById('scanLog');

    function renderBuses(){
      busesDiv.innerHTML = '';
      dashboard.innerHTML = '';
      buses.forEach(b=>{
        const el = document.createElement('div'); el.className='bus';
        el.innerHTML = `<strong>${b.name}</strong> — Capacity: ${b.capacity} — Booked: ${b.assigned.length}`;
        const list = document.createElement('div'); list.className='small';
        list.style.marginTop='6px';
        list.innerText = b.assigned.length? 'Students: '+ b.assigned.map(id=>students[id].name).join(', '): 'No students yet';
        el.appendChild(list);
        busesDiv.appendChild(el);

        const card = document.createElement('div'); card.className='bus';
        card.innerHTML = `<strong>${b.name}</strong> — ${b.assigned.length}/${b.capacity}`;
        const ul = document.createElement('div'); ul.className='small'; ul.style.marginTop='6px';
        ul.innerHTML = b.assigned.length? b.assigned.map(id=>{
          const s = students[id];
          return `${s.name} — ${s.pickup} ${s.done? '✅ Done':'⏳ Pending'}`;
        }).join('<br>') : 'Empty';
        card.appendChild(ul);
        dashboard.appendChild(card);
      });
    }

    document.getElementById('addBus').addEventListener('click',()=>{
      const name = document.getElementById('busName').value.trim();
      const cap = parseInt(document.getElementById('busCap').value,10) || 10;
      if(!name){alert('Enter a bus name');return}
      let found = buses.find(b=>b.name===name);
      if(found){found.capacity = cap;}
      else { buses.push({id:Date.now()+Math.random(),name,capacity:cap,assigned:[]}); }
      renderBuses();
      document.getElementById('busName').value='';
      document.getElementById('busCap').value='10';
    });

    function findBestBus(){
      const available = buses.filter(b=>b.assigned.length < b.capacity);
      if(available.length===0) return null;
      available.sort((a,b)=>a.assigned.length - b.assigned.length);
      return available[0];
    }

    document.getElementById('registerStudent').addEventListener('click',async()=>{
      const name = document.getElementById('studentName').value.trim();
      const pickup = document.getElementById('pickupPoint').value.trim();
      if(!name || !pickup){alert('Please fill name and pickup location'); return}
      const bus = findBestBus();
      if(!bus){ registerResult.innerHTML = '<div class="warn">No available buses now.</div>'; return }
      const id = 'ST-'+Math.floor(Math.random()*900000+100000);
      students[id] = {id,name,pickup,busId:bus.id,done:false};
      bus.assigned.push(id);
      renderBuses();

      const payload = JSON.stringify({studentId:id, name:name});
      studentCodeArea.innerHTML = '';
      const wrapper = document.createElement('div');
      const info = document.createElement('div'); info.innerHTML = `<strong>${name}</strong><br>Bus: ${bus.name}<br>Code: ${id}`;
      wrapper.appendChild(info);
      const canvas = document.createElement('div'); canvas.style.marginTop='8px';
      wrapper.appendChild(canvas);
      studentCodeArea.appendChild(wrapper);
      await QRCode.toCanvas(canvas, payload, {width:180});

      registerResult.innerHTML = `<div class='success'>${name} assigned to ${bus.name} — Code: ${id}</div>`;
      document.getElementById('studentName').value=''; document.getElementById('pickupPoint').value='';
    });

    let html5QrScanner = null;
    document.getElementById('startScan').addEventListener('click',()=>{
      const scannerDiv = document.getElementById('scanner');
      scannerDiv.innerHTML = '';
      html5QrScanner = new Html5Qrcode("scanner");
      Html5Qrcode.getCameras().then(cameras=>{
        if(cameras && cameras.length){
          const camId = cameras[0].id;
          html5QrScanner.start(camId, {fps:10, qrbox:250}, qrCodeMessage => {
            handleScanned(qrCodeMessage);
          });
        } else { scanLog.innerText = 'No camera found.' }
      }).catch(err=>{ scanLog.innerText = 'Camera error: '+err });
    });

    document.getElementById('stopScan').addEventListener('click',()=>{
      if(html5QrScanner){ html5QrScanner.stop().then(()=>{ scanLog.innerText='Scanner stopped'; document.getElementById('scanner').innerText='Scanner will appear here when started'; }).catch(()=>{}); }
    });

    function handleScanned(message){
      let data = null;
      try{ data = JSON.parse(message); } catch(e){ scanLog.innerText = 'Invalid QR: '+message; return }
      const id = data.studentId;
      if(!students[id]){ scanLog.innerText = 'Unknown student: '+id; return }
      if(students[id].done){ scanLog.innerText = students[id].name + ' already marked.'; return }
      students[id].done = true;
      const bus = buses.find(b=>b.id === students[id].busId);
      renderBuses();
      scanLog.innerText = 'Checkout confirmed for: '+students[id].name + ' ✅';
    }

  
    renderBuses();
  </script>
</body>
</html>

